module.exports=[53940,a=>{"use strict";let b="offline-routes";function c(a,b,c,d){let e=a*Math.PI/180,f=c*Math.PI/180,g=(c-a)*Math.PI/180,h=(d-b)*Math.PI/180,i=Math.sin(g/2)*Math.sin(g/2)+Math.cos(e)*Math.cos(f)*Math.sin(h/2)*Math.sin(h/2);return 2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i))*6371e3}async function d(a,c){let d=await new Promise((a,c)=>{let d=indexedDB.open("aurora-routes",1);d.onerror=()=>c(d.error),d.onsuccess=()=>a(d.result),d.onupgradeneeded=a=>{let c=a.target.result;c.objectStoreNames.contains(b)||c.createObjectStore(b,{keyPath:"id",autoIncrement:!0})}}),e=d.transaction([b],"readwrite").objectStore(b);await new Promise((b,d)=>{let f=e.put({routeId:a,coordinates:c,timestamp:Date.now()});f.onsuccess=()=>b(),f.onerror=()=>d(f.error)}),d.close()}class e{watchId=null;state={isTracking:!1,isPaused:!1,coordinates:[],stats:{distance:0,duration:0,pace:0,elevationGain:0},startTime:null,pausedTime:0};lastSampleTime=0;lastSamplePosition=null;onUpdate=null;onError=null;start(a,b){this.state.isTracking||(this.onUpdate=a,this.onError=b||null,this.state.isTracking=!0,this.state.isPaused=!1,this.state.startTime=Date.now(),this.lastSampleTime=Date.now(),"geolocation"in navigator?this.watchId=navigator.geolocation.watchPosition(a=>this.handlePosition(a),a=>this.handleError(a),{enableHighAccuracy:!0,timeout:1e4,maximumAge:0}):this.handleError({code:0,message:"Geolocation not supported"}))}pause(){this.state.isTracking&&!this.state.isPaused&&(this.state.isPaused=!0,this.notifyUpdate())}resume(){this.state.isTracking&&this.state.isPaused&&(this.state.isPaused=!1,this.state.pausedTime+=Date.now()-(this.lastSampleTime||Date.now()),this.lastSampleTime=Date.now(),this.notifyUpdate())}stop(){return null!==this.watchId&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.state.isTracking=!1,this.state.isPaused=!1,this.state.startTime&&(this.state.stats.duration=Math.floor((Date.now()-this.state.startTime-this.state.pausedTime)/1e3)),{...this.state}}getState(){return{...this.state}}handlePosition(a){if(!this.state.isTracking||this.state.isPaused)return;let b={lat:a.coords.latitude,lng:a.coords.longitude,timestamp:a.timestamp,elevation:a.coords.altitude||void 0};this.shouldSample(b)&&(this.state.coordinates.push(b),this.lastSamplePosition=b,this.lastSampleTime=Date.now(),this.updateStats(),this.notifyUpdate(),this.state.coordinates.length%10==0&&this.saveToOfflineStorage())}shouldSample(a){return!!(!this.lastSamplePosition||Date.now()-this.lastSampleTime>=5e3||c(this.lastSamplePosition.lat,this.lastSamplePosition.lng,a.lat,a.lng)>=10)}updateStats(){this.state.stats.distance=function(a){if(a.length<2)return 0;let b=0;for(let d=1;d<a.length;d++)b+=c(a[d-1].lat,a[d-1].lng,a[d].lat,a[d].lng);return b}(this.state.coordinates),this.state.stats.elevationGain=function(a){if(a.length<2)return 0;let b=0;for(let c=1;c<a.length;c++){let d=a[c-1].elevation||0,e=a[c].elevation||0;e>d&&(b+=e-d)}return b}(this.state.coordinates),this.state.startTime&&(this.state.stats.duration=Math.floor((Date.now()-this.state.startTime-this.state.pausedTime)/1e3)),this.state.stats.distance>0&&this.state.stats.duration>0&&(this.state.stats.pace=this.state.stats.duration/60/(this.state.stats.distance/1e3))}handleError(a){console.error("GPS Error:",a),this.onError&&this.onError(a)}notifyUpdate(){this.onUpdate&&this.onUpdate({...this.state})}async saveToOfflineStorage(){try{await d("current",this.state.coordinates)}catch(a){console.error("Failed to save offline route:",a)}}}function f(a){let b=Math.floor(a/3600),c=Math.floor(a%3600/60),d=a%60;return b>0?`${b}:${c.toString().padStart(2,"0")}:${d.toString().padStart(2,"0")}`:`${c}:${d.toString().padStart(2,"0")}`}function g(a){return a>=1e3?`${(a/1e3).toFixed(2)} km`:`${Math.round(a)} m`}function h(a){if(!isFinite(a)||0===a)return"--:--";let b=Math.floor(a),c=Math.round((a-b)*60);return`${b}:${c.toString().padStart(2,"0")}`}a.s(["GPSTracker",()=>e,"formatDistance",()=>g,"formatDuration",()=>f,"formatPace",()=>h])},48124,a=>{"use strict";let b=(0,a.i(70106).default)("square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);a.s(["Square",()=>b],48124)},8549,a=>{"use strict";let b=(0,a.i(70106).default)("pause",[["rect",{x:"14",y:"3",width:"5",height:"18",rx:"1",key:"kaeet6"}],["rect",{x:"5",y:"3",width:"5",height:"18",rx:"1",key:"1wsw3u"}]]);a.s(["Pause",()=>b],8549)},31416,a=>{"use strict";var b=a.i(87924),c=a.i(72131);a.i(11241);var d=a.i(96373),e=a.i(1322),f=a.i(40695),g=a.i(25015),h=a.i(8549),i=a.i(48124);let j=(0,a.i(70106).default)("circle-alert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);var k=a.i(50944),l=a.i(53940);a.i(95258);var m=a.i(33176),n=a.i(31589);function o(){let[a,o]=(0,c.useState)(null),[p,q]=(0,c.useState)(null),[r,s]=(0,c.useState)(null),[t,u]=(0,c.useState)(null),[v,w]=(0,c.useState)("walking"),[x,y]=(0,c.useState)(!0),[z,A]=(0,c.useState)(""),B=(0,c.useRef)(null),C=(0,k.useRouter)(),D=(0,d.useMutation)(e.api.routes.startRoute),E=(0,d.useMutation)(e.api.routes.saveCoordinates);(0,c.useEffect)(()=>{(async()=>{try{let a=await fetch("/api/auth/me"),b=await a.json();b.userId&&o(b.userId)}catch(a){console.error("Error getting user:",a)}})()},[]);let F=async()=>{if(a)try{let b=await D({userId:a,routeType:v});q(b.routeId),y(!1);let c=new l.GPSTracker;B.current=c,c.start(a=>{s(a),a.coordinates.length%10==0&&b.routeId&&E({routeId:b.routeId,coordinates:a.coordinates.slice(-10)}).catch(console.error)},a=>{u(a.message)})}catch(a){u("Failed to start tracking"),console.error(a)}},G=r?.coordinates[r.coordinates.length-1];return(0,b.jsxs)("div",{className:"h-screen flex flex-col bg-gray-900",children:[(0,b.jsx)("div",{role:"status","aria-live":"polite","aria-atomic":"true",className:"sr-only",children:z}),(0,b.jsxs)("div",{className:"flex-1 relative",children:[G&&(0,b.jsxs)(m.default,{mapboxAccessToken:"pk.eyJ1IjoibWFsdW5hbyIsImEiOiJjbGNnZTBrd2EyYmRjM29uMndzZDZ2cWRxIn0.7ffmNPdwDu1nU-PkgFgEsw",initialViewState:{longitude:G.lng,latitude:G.lat,zoom:15},style:{width:"100%",height:"100%"},mapStyle:"mapbox://styles/mapbox/streets-v12",children:[(0,b.jsx)(n.Marker,{longitude:G.lng,latitude:G.lat,children:(0,b.jsx)("div",{className:"w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-lg"})}),r&&r.coordinates.length>1&&(0,b.jsx)(n.Source,{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:r.coordinates.map(a=>[a.lng,a.lat])}},children:(0,b.jsx)(n.Layer,{id:"route",type:"line",paint:{"line-color":"#8b5cf6","line-width":4}})})]}),!G&&(0,b.jsx)("div",{className:"w-full h-full flex items-center justify-center bg-gray-800",children:(0,b.jsx)("p",{className:"text-white",children:"Waiting for GPS signal..."})}),r&&!x&&(0,b.jsx)("div",{className:"absolute top-4 left-4 right-4 bg-white rounded-lg shadow-lg p-4",children:(0,b.jsxs)("div",{className:"grid grid-cols-3 gap-4 text-center",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-xs text-gray-500",children:"Distance"}),(0,b.jsx)("p",{className:"text-lg font-bold",children:(0,l.formatDistance)(r.stats.distance)})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-xs text-gray-500",children:"Duration"}),(0,b.jsx)("p",{className:"text-lg font-bold",children:(0,l.formatDuration)(r.stats.duration)})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-xs text-gray-500",children:"Pace"}),(0,b.jsx)("p",{className:"text-lg font-bold",children:(0,l.formatPace)(r.stats.pace)})]})]})}),t&&(0,b.jsxs)("div",{className:"absolute top-4 left-4 right-4 bg-red-500 text-white rounded-lg p-4 flex items-center gap-2",children:[(0,b.jsx)(j,{className:"w-5 h-5"}),(0,b.jsx)("p",{children:t})]})]}),(0,b.jsx)("div",{className:"bg-white border-t p-4",children:x?(0,b.jsxs)("div",{className:"max-w-md mx-auto space-y-4",children:[(0,b.jsx)("h3",{className:"font-semibold text-center",children:"Select Activity Type"}),(0,b.jsx)("div",{className:"grid grid-cols-2 gap-3",children:["walking","running","cycling","commuting"].map(a=>(0,b.jsx)(f.Button,{variant:v===a?"default":"outline",onClick:()=>w(a),className:"capitalize",children:a},a))}),(0,b.jsxs)(f.Button,{onClick:F,className:"w-full min-h-[56px]",size:"lg","aria-label":"Start tracking route",children:[(0,b.jsx)(g.Play,{className:"w-5 h-5 mr-2","aria-hidden":"true"}),"Start Tracking"]})]}):(0,b.jsxs)("div",{className:"max-w-md mx-auto flex gap-3",children:[r?.isPaused?(0,b.jsxs)(f.Button,{onClick:()=>{B.current?.resume(),A("Route tracking resumed")},size:"lg",className:"flex-1 min-h-[56px]","aria-label":"Resume route tracking",children:[(0,b.jsx)(g.Play,{className:"w-5 h-5 mr-2","aria-hidden":"true"}),"Resume"]}):(0,b.jsxs)(f.Button,{onClick:()=>{B.current?.pause(),A("Route tracking paused")},variant:"outline",size:"lg",className:"flex-1 min-h-[56px]","aria-label":"Pause route tracking",children:[(0,b.jsx)(h.Pause,{className:"w-5 h-5 mr-2","aria-hidden":"true"}),"Pause"]}),(0,b.jsxs)(f.Button,{onClick:()=>{B.current&&p&&(B.current.stop(),A("Route tracking stopped"),C.push(`/routes/complete/${p}`))},variant:"destructive",size:"lg",className:"flex-1 min-h-[56px]","aria-label":"Stop route tracking",children:[(0,b.jsx)(i.Square,{className:"w-5 h-5 mr-2","aria-hidden":"true"}),"Stop"]})]})})]})}a.s(["default",()=>o],31416)},2880,a=>{a.v(b=>Promise.all(["server/chunks/ssr/node_modules_mapbox-gl_dist_mapbox-gl_32a5203b.js"].map(b=>a.l(b))).then(()=>b(53311)))}];

//# sourceMappingURL=_a8d4a4de._.js.map